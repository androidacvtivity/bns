SELECT 

L.CUIIO,
R.DENUMIRE,
R.CUATM,
R.CFP,
R.CAEM2,
L.E_2019,
L.I_2019,
L.E_2020,
L.I_2020, 
L.E_TRIM_1,
L.E_TRIM_2,
L.E_TRIM_3,
L.I_TRIM_1,
L.I_TRIM_2,
L.I_TRIM_3



FROM 
(

SELECT 

D.CUIIO,
E_2019,
I_2019,
E_2020,
I_2020, 
E_TRIM_1,
E_TRIM_2,
E_TRIM_3,
I_TRIM_1,
I_TRIM_2,
I_TRIM_3



FROM 
(
SELECT
DISTINCT D.CUIIO,
SUM(CASE WHEN D.FORM = 46 AND  D.PERIOADA IN (2008) AND CAPITOL IN (1) THEN D.RIND END) AS E_2019,
SUM(CASE WHEN D.FORM = 46 AND  D.PERIOADA IN (2008) AND CAPITOL IN (404) THEN D.RIND END) AS I_2019,

SUM(CASE WHEN D.FORM = 46 AND  D.PERIOADA IN (2009) AND CAPITOL IN (1) THEN D.RIND END) AS E_2020,
SUM(CASE WHEN D.FORM = 46 AND  D.PERIOADA IN (2009) AND CAPITOL IN (404) THEN D.RIND END) AS I_2020,

SUM(CASE WHEN D.FORM = 44 AND  D.PERIOADA IN (1048) AND CAPITOL IN (1) THEN D.RIND END) AS E_TRIM_1,
SUM(CASE WHEN D.FORM = 44 AND  D.PERIOADA IN (1049) AND CAPITOL IN (1) THEN D.RIND END) AS E_TRIM_2,
SUM(CASE WHEN D.FORM = 44 AND  D.PERIOADA IN (1050) AND CAPITOL IN (1) THEN D.RIND END) AS E_TRIM_3,
SUM(CASE WHEN D.FORM = 44 AND  D.PERIOADA IN (1048) AND CAPITOL IN (14) THEN D.RIND END) AS I_TRIM_1,
SUM(CASE WHEN D.FORM = 44 AND  D.PERIOADA IN (1049) AND CAPITOL IN (14) THEN D.RIND END) AS I_TRIM_2,
SUM(CASE WHEN D.FORM = 44 AND  D.PERIOADA IN (1050) AND CAPITOL IN (14) THEN D.RIND END) AS I_TRIM_3
FROM
CIS2.VW_DATA_ALL D 

 
WHERE
(D.PERIOADA IN (1048,1049,1050,2008,2009)
AND (D.FORM IN (44,46))
AND D.CAPITOL IN (14,1,404)
AND D.RIND IN('05','02','03')
AND NVAL(D.COL1) = 1)

GROUP BY
D.CUIIO

) D

GROUP BY 
D.CUIIO,
E_2019,
I_2019,
E_2020,
I_2020, 
E_TRIM_1,
E_TRIM_2,
E_TRIM_3,
I_TRIM_1,
I_TRIM_2,
I_TRIM_3

HAVING 
E_2019  IS NOT NULL
AND 
I_2019  IS NOT NULL
AND 
E_2020  IS NOT NULL
AND 
I_2020  IS NOT NULL
AND 
E_TRIM_1  IS NOT NULL
AND 
E_TRIM_2  IS NOT NULL
AND 
E_TRIM_3  IS NOT NULL
AND 
I_TRIM_1  IS NOT NULL
AND 
I_TRIM_2  IS NOT NULL
AND 
I_TRIM_3  IS NOT NULL

) L  RIGHT JOIN USER_BANCU.VW_KATALOG_EI_78_1050 R ON R.CUIIO = L.CUIIO 

WHERE 
L.CUIIO IS NOT NULL