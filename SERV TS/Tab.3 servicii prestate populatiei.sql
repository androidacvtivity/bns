--INSERT INTO TABLE_OUT
--(
--  PERIOADA,
--  FORM,
--  FORM_VERS,
--  ID_MDTABLE,
--  COD_CUATM,
--  NR_SECTIE,
--  NUME_SECTIE,
--  NR_SECTIE1,
--  NUME_SECTIE1,
--  NR_SECTIE2,
--  NUME_SECTIE2,
--  NR_ROW,
--  ORDINE,
--  DECIMAL_POS,
--  NUME_ROW,
--  
--  COL1, COL2, COL3, COL4, COL5, COL6, COL7, COL8, COL9, COL10
--)
SELECT                                                                      
  :pPERIOADA AS PERIOADA,                                                    
  :pFORM AS FORM,                                                            
  :pFORM_VERS AS FORM_VERS,                                                  
  :pID_MDTABLE AS ID_MDTABLE,                                                
  :pCOD_CUATM AS COD_CUATM,                                                  
  '0' AS NR_SECTIE,                                                         
  '0' AS NUME_SECTIE,                                                        
  '0' AS NR_SECTIE1,
  '0' AS NUME_SECTIE1,
  '0' AS NR_SECTIE2,
  '0' AS NUME_SECTIE2,
   CODUL||'~'||ROWNUM AS NR_ROW,  
   ROWNUM AS ORDINE,
  '0000000000' AS DECIMAL_POS,
   DENUMIRE AS NUME_ROW,
   ROUND(COL1,1) AS COL1,
  ROUND(COL2,1) AS COL2,
  ROUND(COL3,1) AS COL3,
  ROUND(COL4,1) AS COL4,
  ROUND(COL5,1) AS COL5,
  ROUND(COL6,1) AS COL6,
  ROUND(COL7,1) AS COL7,
  ROUND(COL8,1) AS COL8,
  ROUND(COL9,1) AS COL9,
  ROUND(COL10,1) AS COL10 FROM (
SELECT
  C.FULL_CODE,
  C.DENUMIRE,
  C.CODUL,  
  
  
   ROUND(SUM(CASE WHEN  D.PERIOADA BETWEEN FLOOR(:pPERIOADA/12)*12 AND :pPERIOADA THEN D.COL1 ELSE NULL END),1) AS COL1,
 
 ROUND(((SUM(CASE WHEN D.FORM = 4 AND D.CAPITOL = 4 AND D.PERIOADA BETWEEN FLOOR(:pPERIOADA/12)*12 AND :pPERIOADA THEN COL1 END)/
  (SELECT COL1 FROM CIS.VW_DATA_ALL_COEF WHERE FORM = 100 AND RIND = '01' AND CAPITOL = 30 AND PERIOADA = :pPERIOADA))*100)/
   (SUM(CASE WHEN D.FORM = 4 AND D.CAPITOL = 4 AND D.PERIOADA BETWEEN FLOOR((:pPERIOADA-12)/12)*12 AND :pPERIOADA-12 THEN COL1 END))*100,1) AS COL2,
   
   SUM(CASE WHEN D.CFP IN (11,12,13) AND D.PERIOADA BETWEEN FLOOR(:pPERIOADA/12)*12 AND :pPERIOADA THEN COL1 ELSE 0 END) AS COL3,
 
 ROUND(((SUM(CASE WHEN D.CFP IN (11,12,13) AND D.FORM = 4 AND D.CAPITOL = 4 AND D.PERIOADA BETWEEN FLOOR(:pPERIOADA/12)*12 AND :pPERIOADA THEN COL1 END)/
  (SELECT COL1 FROM CIS.VW_DATA_ALL_COEF WHERE FORM = 100 AND RIND = '01' AND CAPITOL = 30 AND PERIOADA = :pPERIOADA))*100)/
   (SUM(CASE WHEN D.CFP IN (11,12,13) AND D.FORM = 4 AND D.CAPITOL = 4 AND D.PERIOADA BETWEEN FLOOR((:pPERIOADA-12)/12)*12 AND :pPERIOADA-12 THEN COL1 END))*100,1) AS COL4,
   
 SUM(CASE WHEN D.CFP IN (14,16,18,19) AND D.PERIOADA BETWEEN FLOOR(:pPERIOADA/12)*12 AND :pPERIOADA THEN COL1 ELSE 0 END) AS COL5,
 
 ROUND(((SUM(CASE WHEN D.CFP IN (14,16,18,19) AND D.FORM = 4 AND D.CAPITOL = 4 AND D.PERIOADA BETWEEN FLOOR(:pPERIOADA/12)*12 AND :pPERIOADA THEN COL1 END)/
  (SELECT COL1 FROM CIS.VW_DATA_ALL_COEF WHERE FORM = 100 AND RIND = '01' AND CAPITOL = 30 AND PERIOADA = :pPERIOADA))*100)/
   (SUM(CASE WHEN D.CFP IN (14,16,18,19) AND D.FORM = 4 AND D.CAPITOL = 4 AND D.PERIOADA BETWEEN FLOOR((:pPERIOADA-12)/12)*12 AND :pPERIOADA-12 THEN COL1 END))*100,1) AS COL6,
   
   
 SUM(CASE WHEN  D.CFP IN (20) AND D.PERIOADA BETWEEN FLOOR(:pPERIOADA/12)*12 AND :pPERIOADA THEN COL1 ELSE 0 END) AS COL7,
 
 ROUND(((SUM(CASE WHEN  D.CFP IN (20) AND D.FORM = 4 AND D.CAPITOL = 4 AND D.PERIOADA BETWEEN FLOOR(:pPERIOADA/12)*12 AND :pPERIOADA THEN COL1 END)/
  (SELECT COL1 FROM CIS.VW_DATA_ALL_COEF WHERE FORM = 100 AND RIND = '01' AND CAPITOL = 30 AND PERIOADA = :pPERIOADA))*100)/
   (SUM(CASE WHEN  D.CFP IN (20) AND D.FORM = 4 AND D.CAPITOL = 4 AND D.PERIOADA BETWEEN FLOOR((:pPERIOADA-12)/12)*12 AND :pPERIOADA-12 THEN COL1 END))*100,1) AS COL8,
   
   
 SUM(CASE WHEN  D.CFP IN (23,24,25,26,27,28) AND D.PERIOADA BETWEEN FLOOR(:pPERIOADA/12)*12 AND :pPERIOADA THEN COL1 ELSE 0 END) AS COL9,
 
 ROUND(((SUM(CASE WHEN  D.CFP IN (23,24,25,26,27,28) AND D.FORM = 4 AND D.CAPITOL = 4 AND D.PERIOADA BETWEEN FLOOR(:pPERIOADA/12)*12 AND :pPERIOADA THEN COL1 END)/
  (SELECT COL1 FROM CIS.VW_DATA_ALL_COEF WHERE FORM = 100 AND RIND = '01' AND CAPITOL = 30 AND PERIOADA = :pPERIOADA))*100)/
   (SUM(CASE WHEN  D.CFP IN (23,24,25,26,27,28) AND D.FORM = 4 AND D.CAPITOL = 4 AND D.PERIOADA BETWEEN FLOOR((:pPERIOADA-12)/12)*12 AND :pPERIOADA-12 THEN COL1 END))*100,1) AS COL10 

  
  
 
  
FROM 
  CIS.VW_DATA_ALL_COEF D
  INNER JOIN CIS.VW_CL_CUATM A ON (D.CUATM=A.CODUL)
  INNER JOIN CIS.VW_CL_CUATM C ON (A.FULL_CODE LIKE '%'||C.CODUL||';%')
  INNER JOIN CIS.VW_CL_CAEM2 CC ON CC.CODUL = D.CAEM2
 
    
  
  
WHERE
 (D.FORM=:pFORM) AND
 (D.FORM_VERS=:pFORM_VERS) AND
 (:pID_MDTABLE=:pID_MDTABLE) AND
 (D.CUATM_FULL LIKE '%'||:pCOD_CUATM||';%') AND   
  (
     (D.PERIOADA BETWEEN FLOOR((:pPERIOADA-12)/12)*12 AND :pPERIOADA-12) OR 
     (D.PERIOADA BETWEEN FLOOR(:pPERIOADA/12)*12 AND :pPERIOADA) OR
     (D.PERIOADA IN :pPERIOADA) OR
     (D.PERIOADA IN :pPERIOADA-1) ) AND
  D.FORM IN (4) AND 
  D.CAPITOL IN (4) AND
  D.RIND IN '10' AND
 -- D.TIP = 1 AND
  C.PRGS IN ('2')
  
   AND D.CAEM2 IN (
  
  SELECT 
   CODUL
     FROM CIS.VW_CL_CAEM2
          
          WHERE
          SUBSTR(CODUL,2,5) IN ('5500','5510','5520','5530','5590','5600','5610','5620','5621','5629'
                               ,'5630','7420','7500','7720','7721','7722','7729','7900','7910','7911'
                               ,'7912','7990','8500','8510','8520','8530','8531','8532','8540','8541'
                               ,'8542','8550','8551','8552','8553','8559','8560','8600','8610','8620'
                               ,'8621','8622','8623','8690','8700','8710','8720','8730','8790','8800'
                               ,'8810','8890','8891','8899','5900','5910','5911','5912','5913','5914'
                               ,'5920','6000','6010','6020','9000','9001','9002','9003','9004','9100'
                               ,'9101','9102','9103','9104','9200','9300','9310','9311','9312','9313'
                               ,'9319','9320','9321','9329','9500','9510','9511','9512','9520','9521'
                               ,'9522','9523','9524','9525','9529','9601','9602','9603','9604','0160'
                                ,'0161','0162','0163','0164','7430','9609')  
          
  )
  
  
GROUP BY
  C.FULL_CODE,
  C.DENUMIRE,
  C.CODUL
  )