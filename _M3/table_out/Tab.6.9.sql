--INSERT INTO TABLE_OUT 
--(
--  PERIOADA,
--  FORM,
--  FORM_VERS,
--  ID_MDTABLE,
--  COD_CUATM,
--  NR_SECTIE,
--  NUME_SECTIE,
--  NR_SECTIE1,
--  NUME_SECTIE1,
--  NR_SECTIE2,
--  NUME_SECTIE2,
--  NR_ROW,
--  ORDINE,
--  DECIMAL_POS,
--  NUME_ROW,
--  
--  COL1, COL2, COL3,  COL4, COL5, COL6, COL7, COL8, COL9, COL10, COL11, COL12, COL13, COL14, COL15, COL16, COL17, COL18, COL19, COL20
--)
----------------------------------------------------------------
SELECT
  :pPERIOADA AS PERIOADA,
  :pFORM AS FORM,
  :pFORM_VERS AS FORM_VERS,
  :pID_MDTABLE AS ID_MDTABLE,
  :pCOD_CUATM AS COD_CUATM,
  
         
  '0' AS NR_SECTIE,
  '0' AS NUME_SECTIE,
  '0' AS NR_SECTIE1,
  '0' AS NUME_SECTIE1,
  '0' AS NR_SECTIE2,
  '0' AS NUME_SECTIE2,
  NR_ROW,
  ROWNUM AS ORDINE,
  '00000001111111111111' AS DECIMAL_POS,
  NUME_ROW,
  COL1, COL2, COL3,  COL4, COL5, COL6, COL7, COL8, COL9, COL10, COL11, COL12, COL13, COL14, COL15, COL16, COL17, COL18, COL19, COL20
  
FROM
(
SELECT
  
   CAEM2||'~'||CUIIO||'_'||CFP||'_'||FILIAL AS NR_ROW,
   DENUMIRE AS NUME_ROW,
   CUIIO AS COL1,
   CUATM AS COL2,
   CFP AS COL3,
   FILIAL AS COL4,
   MAX(PACHET) AS COL5,
   BUGET AS COL6,
   TIP_CAEM2 AS COL7,
   ROUND(SUM(T1.COL9),1) AS COL8,
   ROUND(SUM(D.COL1),1) AS COL9,
   ROUND(SUM(COL2),1) AS COL10,
   ROUND(SUM(COL3),1) AS COL11,
   ROUND(SUM(D.COL4),1) AS COL12,
   ROUND(SUM(D.COL5),1) AS COL13,
   ROUND(SUM(COL6),1) AS COL14,
   ROUND(SUM(COL7),1) AS COL15,
   ROUND(SUM(D.COL8),1) AS COL16,
   ROUND(SUM(D.COL9),1) AS COL17, 
   ROUND(NOZERO(SUM(D.COL1))/NOZERO(SUM(T1.COL9))*1000/12,1) AS COL18,
   ROUND(SUM(T2.COL18),1) AS COL19,
   ROUND(NOZERO(NOZERO(SUM(D.COL1))/NOZERO(SUM(T1.COL9))*1000/12)/NOZERO(SUM(T2.COL18))*100,1) AS COL20
FROM
(SELECT 
  CR.CODUL AS CAEM2,
  RN.DENUMIRE,
  D.CUIIO,
  D.CUATM,
  D.CFP,
  D.FILIAL,
  MAX(D.PACHET) AS PACHET,
  D.BUGET,
  MAX(CASE WHEN CR.CODUL LIKE '00000' THEN 1 ELSE TIP_CAEM2 END) AS TIP_CAEM2,
  SUM(NVAL(CASE WHEN CAPITOL IN (303) AND COL=1 AND RIND LIKE '%T' THEN VAL ELSE NULL END)-
      NVAL(CASE WHEN CAPITOL IN (303) AND COL=1 AND RIND LIKE '%F' THEN VAL ELSE NULL END)) AS COL1,
  SUM(NVAL(CASE WHEN CAPITOL IN (303) AND COL=2 AND RIND LIKE '%T' THEN VAL ELSE NULL END)-
      NVAL(CASE WHEN CAPITOL IN (303) AND COL=2 AND RIND LIKE '%F' THEN VAL ELSE NULL END)) AS COL2,
  SUM(NVAL(CASE WHEN CAPITOL IN (303) AND COL=3 AND RIND LIKE '%T' THEN VAL ELSE NULL END)-
      NVAL(CASE WHEN CAPITOL IN (303) AND COL=3 AND RIND LIKE '%F' THEN VAL ELSE NULL END)) AS COL3,
  SUM(NVAL(CASE WHEN CAPITOL IN (303) AND COL=4 AND RIND LIKE '%T' THEN VAL ELSE NULL END)-
      NVAL(CASE WHEN CAPITOL IN (303) AND COL=4 AND RIND LIKE '%F' THEN VAL ELSE NULL END)) AS COL4,
  SUM(NVAL(CASE WHEN CAPITOL IN (303) AND COL=5 AND RIND LIKE '%T' THEN VAL ELSE NULL END)-
      NVAL(CASE WHEN CAPITOL IN (303) AND COL=5 AND RIND LIKE '%F' THEN VAL ELSE NULL END)) AS COL5,
  SUM(NVAL(CASE WHEN CAPITOL IN (303) AND COL=6 AND RIND LIKE '%T' THEN VAL ELSE NULL END)-
      NVAL(CASE WHEN CAPITOL IN (303) AND COL=6 AND RIND LIKE '%F' THEN VAL ELSE NULL END)) AS COL6,
  SUM(NVAL(CASE WHEN CAPITOL IN (303) AND COL=7 AND RIND LIKE '%T' THEN VAL ELSE NULL END)-
      NVAL(CASE WHEN CAPITOL IN (303) AND COL=7 AND RIND LIKE '%F' THEN VAL ELSE NULL END)) AS COL7,
  SUM(NVAL(CASE WHEN CAPITOL IN (303) AND COL=8 AND RIND LIKE '%T' THEN VAL ELSE NULL END)-
      NVAL(CASE WHEN CAPITOL IN (303) AND COL=8 AND RIND LIKE '%F' THEN VAL ELSE NULL END)) AS COL8,
  SUM(NVAL(CASE WHEN CAPITOL IN (303) AND COL=9 AND RIND LIKE '%T' THEN VAL ELSE NULL END)-
      NVAL(CASE WHEN CAPITOL IN (303) AND COL=9 AND RIND LIKE '%F' THEN VAL ELSE NULL END)) AS COL9,
  SUM(NVAL(CASE WHEN CAPITOL IN (303) AND COL=10 AND RIND LIKE '%T' THEN VAL ELSE NULL END)-
      NVAL(CASE WHEN CAPITOL IN (303) AND COL=10 AND RIND LIKE '%F' THEN VAL ELSE NULL END)) AS COL10,
  SUM(NVAL(CASE WHEN CAPITOL IN (301) AND COL=1 AND RIND LIKE '%T' THEN VAL ELSE NULL END)-
      NVAL(CASE WHEN CAPITOL IN (301) AND COL=1 AND RIND LIKE '%F' THEN VAL ELSE NULL END)) AS COL11     
FROM
(
-------------------------------------------------------------------------------
SELECT DISTINCT
  D.CUIIO,
  D.CUIIO_VERS,
  D.FILIAL,
  D.CAPITOL,
  D.CAPITOL_DEN,
  D.CUATM_FULL,
  D.CUATM,
  D.CFP,
  D.PACHET,
  D.BUGET,
  C.COL-1 AS COL,
  CASE WHEN D.RIND LIKE '%T' AND S.SEX LIKE 'F' THEN SUBSTR(D.RIND,1,3)||'F' ELSE D.RIND END AS RIND, 
  MAX(CASE WHEN D.RIND LIKE '00%' THEN 0 WHEN D.RIND LIKE '01%' THEN TO_NUMBER(SUBSTR(D.CAEM2,2,5)) ELSE D.COL1 END) AS CAEM2,
  MAX(CASE WHEN D.RIND LIKE '00%' THEN 1 WHEN D.RIND LIKE '01%' THEN 2 ELSE 3 END) AS TIP_CAEM2,
  SUM(CASE WHEN D.RIND LIKE '%'||S.SEX THEN DECODE(C.COL, 1,D.COL1, 2,D.COL2, 3,D.COL3, 4,D.COL4, 5,D.COL5, 6,D.COL6, 7,D.COL7, 8,D.COL8, 9,D.COL9, 10,D.COL10, 11,D.COL11, NULL) ELSE NULL END) AS VAL
FROM 
  VW_DATA_ALL D,
  (
    SELECT  2 AS COL FROM DUAL UNION
    SELECT  3 AS COL FROM DUAL UNION
    SELECT  4 AS COL FROM DUAL UNION
    SELECT  5 AS COL FROM DUAL UNION
    SELECT  6 AS COL FROM DUAL UNION
    SELECT  7 AS COL FROM DUAL UNION
    SELECT  8 AS COL FROM DUAL UNION
    SELECT  9 AS COL FROM DUAL UNION
    SELECT 10 AS COL FROM DUAL UNION
    SELECT 11 AS COL FROM DUAL
  ) C,
  (
    SELECT 'T' AS SEX FROM DUAL UNION
    SELECT 'F' AS SEX FROM DUAL
  ) S
WHERE
  (D.PERIOADA=:pPERIOADA) AND
  (:pFORM_VERS=:pFORM_VERS) AND
  (:pID_MDTABLE=:pID_MDTABLE) AND
  
  D.FORM = 3 AND
  D.CAPITOL IN(301,303)
GROUP BY
  D.CUIIO,
  D.CUIIO_VERS,
  D.FILIAL,
  D.CAPITOL,
  D.CAPITOL_DEN,
  D.CUATM_FULL,
  D.CUATM,
  D.CFP,
  D.PACHET,
  D.BUGET,
  C.COL,
  CASE WHEN D.RIND LIKE '%T' AND S.SEX LIKE 'F' THEN SUBSTR(D.RIND,1,3)||'F' ELSE D.RIND END

-------------------------------------------------------------------------------
) D 
  INNER JOIN VW_CL_CAEM2 C  ON(D.CAEM2=C.NUM_CODE)
  INNER JOIN VW_CL_CAEM2 CR ON(C.FULL_CODE LIKE '%'||CR.CODUL||';%') 
  INNER JOIN RENIM RN ON (RN.CUIIO=D.CUIIO AND RN.CUIIO_VERS = D.CUIIO_VERS)
WHERE 
  D.CAEM2 <> '0' AND 
--  FILIAL = '0' AND 
  (RIND LIKE '%F' OR RIND LIKE '%T')  AND D.CUATM_FULL LIKE '%'||:pCOD_CUATM||';%' AND
  (CR.CODUL LIKE '00000' OR (C.CODUL=CR.CODUL))
--  AND D.CUIIO IN (38406561)
GROUP BY
  RN.DENUMIRE,
  CR.CODUL,
  D.CUIIO,
  D.CUATM,
  D.CFP,
  D.FILIAL,
--  D.PACHET,
  D.BUGET
ORDER BY
  CUIIO,
  CUATM,
  CAEM2
    
  ) D
  
LEFT JOIN (SELECT NR_ROW, COL9, ID_MDTABLE FROM TABLE_OUT  
  
  WHERE  ID_MDTABLE =(CASE WHEN :pPERIOADA>=2002 THEN 5683 ELSE NULL END) AND
    FORM IN (3)              AND 
    FORM_VERS = :PFORM_VERS  AND    
    COD_CUATM IN (:pCOD_CUATM) AND
    PERIOADA = :pPERIOADA
    ) T1
     
  ON (D.CAEM2||'~'||CUIIO||'_'||CFP||'_'||FILIAL=T1.NR_ROW)
  LEFT JOIN (
 SELECT NR_ROW, COL18, ID_MDTABLE FROM TABLE_OUT  
  
  WHERE  
    ID_MDTABLE=(CASE WHEN :pPERIOADA<=2002 THEN NULL ELSE 5739 END) AND
    PERIOADA = :pPERIOADA-1  AND
    FORM IN (3)              AND 
    FORM_VERS = :PFORM_VERS  AND    
    COD_CUATM IN (:pCOD_CUATM)
    ) T2
     
  ON (D.CAEM2||'~'||CUIIO||'_'||CFP||'_'||FILIAL=T2.NR_ROW)
GROUP BY
  CAEM2,
  DENUMIRE,
  CUIIO,
  CUATM,
  CFP,
  FILIAL,
  BUGET,
  TIP_CAEM2
--  T1.COL9,
--  D.COL1,
--  COL2,
--  COL3,
--  D.COL4,
--  D.COL5,
--  COL6,
--  COL7,
--  D.COL8,
--  D.COL9, 
--  NOZERO(D.COL1)/NOZERO(T1.COL9)*1000/12,
--  T2.COL18,
--  NOZERO(NOZERO(D.COL1)/NOZERO(T1.COL9)*1000/12)/NOZERO(T2.COL18)*100
ORDER BY
  CUIIO,
  CUATM,
  CAEM2
)